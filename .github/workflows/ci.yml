name: CI - Valida√ß√£o de Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  validacao:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Baixar c√≥digo do reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Instalar depend√™ncias
        run: npm ci

      # ‚îÄ‚îÄ Etapa 1: Verificar exist√™ncia do index.html ‚îÄ‚îÄ
      - name: Verificar exist√™ncia do index.html
        run: |
          if [ ! -f "index.html" ]; then
            echo "‚ùå ERRO: O arquivo index.html n√£o foi encontrado na raiz do projeto!"
            echo "O GitHub Pages exige um arquivo index.html na raiz para funcionar."
            exit 1
          fi
          echo "‚úÖ index.html encontrado na raiz do projeto."

      # ‚îÄ‚îÄ Etapa 2: Executar Linter HTML ‚îÄ‚îÄ
      - name: Executar Linter (HTMLHint)
        run: npm run lint

      # ‚îÄ‚îÄ Etapa 3: Verificar tamanho dos arquivos (m√°x 500KB) ‚îÄ‚îÄ
      - name: Verificar tamanho dos arquivos (m√°x 500KB)
        run: |
          echo "üîç Verificando arquivos maiores que 500KB..."
          LARGE_FILES=$(find . -type f -not -path './.git/*' -not -path './node_modules/*' -size +500k)
          if [ -n "$LARGE_FILES" ]; then
            echo "‚ùå ERRO: Os seguintes arquivos excedem 500KB:"
            echo "$LARGE_FILES"
            echo ""
            echo "Reduza o tamanho desses arquivos antes de fazer o merge."
            exit 1
          fi
          echo "‚úÖ Todos os arquivos est√£o dentro do limite de 500KB."

      # ‚îÄ‚îÄ Etapa 4: Varredura de coment√°rios e termos sens√≠veis ‚îÄ‚îÄ
      - name: Varredura de termos proibidos (TODO, FIXME, senha, password)
        run: |
          echo "üîç Buscando termos proibidos no c√≥digo..."
          FOUND=0

          if grep -r -n -i "TODO" --include="*.html" --include="*.css" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "‚ùå Encontrado 'TODO' no c√≥digo."
            FOUND=1
          fi

          if grep -r -n -i "FIXME" --include="*.html" --include="*.css" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "‚ùå Encontrado 'FIXME' no c√≥digo."
            FOUND=1
          fi

          if grep -r -n -i "senha" --include="*.html" --include="*.css" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "‚ùå Encontrado 'senha' no c√≥digo."
            FOUND=1
          fi

          if grep -r -n -i "password" --include="*.html" --include="*.css" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "‚ùå Encontrado 'password' no c√≥digo."
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "‚ùå ERRO: Termos proibidos encontrados! Remova TODO, FIXME, senha e password antes do merge."
            exit 1
          fi
          echo "‚úÖ Nenhum termo proibido encontrado."

      # ‚îÄ‚îÄ Etapa 5: Verificar links e caminhos de imagens ‚îÄ‚îÄ
      - name: Verificar links e caminhos de imagens
        run: |
          echo "üîç Verificando caminhos de imagens locais..."
          ERRORS=0

          # Extrair caminhos de src="" das tags img (apenas caminhos locais)
          SRCS=$(grep -o -E 'src="[^"]*"' index.html | sed 's/src="//;s/"//' | grep -v '^http' | grep -v '^//')
          for SRC in $SRCS; do
            if [ ! -f "$SRC" ]; then
              echo "‚ùå Arquivo referenciado n√£o encontrado: $SRC"
              ERRORS=$((ERRORS + 1))
            else
              echo "‚úÖ Encontrado: $SRC"
            fi
          done

          # Verificar se links externos retornam c√≥digo HTTP v√°lido
          echo ""
          echo "üîç Verificando links externos..."
          LINKS=$(grep -o -E 'href="https?://[^"]*"' index.html | sed 's/href="//;s/"//')
          for LINK in $LINKS; do
            # Ignorar links de fontes/CDN que precisam de headers especiais
            if echo "$LINK" | grep -q -E 'fonts.googleapis|fonts.gstatic|cdnjs.cloudflare'; then
              echo "‚è≠Ô∏è  Ignorando CDN/fontes: $LINK"
              continue
            fi
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" -L --max-time 10 "$LINK" || echo "000")
            if [ "$HTTP_CODE" -ge 400 ] || [ "$HTTP_CODE" = "000" ]; then
              echo "‚ùå Link inv√°lido (HTTP $HTTP_CODE): $LINK"
              ERRORS=$((ERRORS + 1))
            else
              echo "‚úÖ Link v√°lido (HTTP $HTTP_CODE): $LINK"
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "‚ùå ERRO: $ERRORS link(s)/caminho(s) inv√°lido(s) encontrado(s)!"
            exit 1
          fi
          echo ""
          echo "‚úÖ Todos os links e caminhos de imagens est√£o v√°lidos."

      # ‚îÄ‚îÄ Notifica√ß√£o de Falha ‚îÄ‚îÄ
      - name: Notifica√ß√£o de falha
        if: failure()
        run: |
          echo "::error::‚ùå A pipeline de CI falhou! Verifique os logs acima para corrigir os erros."
          echo "üìß Em um ambiente real, aqui seria enviada uma notifica√ß√£o por e-mail, Discord ou Slack."
          echo ""
          echo "Para configurar notifica√ß√µes reais, adicione uma das op√ß√µes:"
          echo "  - E-mail: use a action 'dawidd6/action-send-mail@v3'"
          echo "  - Discord: use a action 'sarisia/actions-status-discord@v1'"
          echo "  - Slack: use a action 'slackapi/slack-github-action@v1'"

      # ‚îÄ‚îÄ Notifica√ß√£o de Sucesso ‚îÄ‚îÄ
      - name: Notifica√ß√£o de sucesso
        if: success()
        run: |
          echo "‚úÖ Pipeline de CI conclu√≠da com sucesso!"
          echo "O c√≥digo passou em todas as valida√ß√µes e est√° pronto para merge."
